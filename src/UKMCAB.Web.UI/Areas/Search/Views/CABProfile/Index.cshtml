@using System.Net
@model CABProfileViewModel
@{
    ViewData["nav"] = "search";
    var returnUrl = WebUtility.UrlEncode(this.Url.ActionContext.HttpContext.Request.GetRequestUri().PathAndQuery);
}

@section BackButton
    {
    @if (Model.IsArchived)
    {
        <div class="govuk-width-container ">
            <div class="govuk-grid-row">
                <div class="govuk-grid-column-two-thirds">
                    <a asp-area="Admin" asp-controller="Admin" asp-action="Index" class="govuk-back-link">Back</a>
                </div>
            </div>
        </div>
    }
    else if (Model.ReturnUrl == "confirmation")
    {
        <div class="govuk-width-container ">
            <div class="govuk-grid-row">
                <div class="govuk-grid-column-two-thirds">
                    <a asp-area="Admin" asp-controller="CAB" asp-action="Confirmation" asp-route-id="@Model.CABId" class="govuk-back-link">Back</a>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="govuk-width-container ">
            <div class="govuk-grid-row">
                <div class="govuk-grid-column-two-thirds">
                    <a href="@Model.ReturnUrl" class="govuk-back-link">Back to Search Results</a>
                </div>
            </div>
        </div>
    }
}
<div id="cab-profile-page">
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            <partial name="Partials/_ValidationSummary" model="null" />
        </div>
    </div>
    @if (Model.IsArchived)
    {
        <div class="govuk-notification-banner" role="region"
             aria-labelledby="govuk-notification-banner-title"
             data-module="govuk-notification-banner">
            <div class="govuk-notification-banner__content">

                <div class="govuk-warning-text">
                    <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
                    <strong class="govuk-warning-text__text">
                        <p class="govuk-notification-banner__heading">Archived on @Model.ArchivedDate</p>
                    </strong>
                </div>
            </div>
        </div>
    }

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            <span class="govuk-caption-m govuk-!-margin-bottom-3">CAB profile</span>
            <h1 class="govuk-heading-l">@Model.Name</h1>
            <div class="cab-detail-date-meta">
                <span class="govuk-caption-m govuk-!-display-inline-block govuk-!-margin-right-5">Published: @(Model.PublishedDate.HasValue ? Model.PublishedDate.Value.ToString("d MMM yyyy") : string.Empty)</span>
                <span class="govuk-caption-m govuk-!-display-inline-block">Last updated: @(Model.LastModifiedDate.HasValue ? Model.LastModifiedDate.Value.ToString("d MMM yyyy") : string.Empty)</span>
            </div>
        </div>
        <div class="govuk-grid-column-one-third">

            <div class="govuk-!-margin-right-3">

                <div class="atom-feed atom-feed-top">
                    @if (!Model.IsArchived)
                    {
                        <partial name="Partials/_FeedLinks" model="Model.FeedLinksViewModel" />
                    }
                </div>

                @if (Model.IsLoggedIn && !Model.IsArchived)
                {
                    <div class="govuk-!-display-block govuk-!-text-align-right">
                        <a class="govuk-button govuk-button--secondary" asp-area="Admin" asp-controller="CAB" asp-action="Summary" asp-route-id="@Model.CABId" asp-route-returnUrl="@returnUrl">Edit</a>
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-full">

            <div class="govuk-tabs cab-tabs" data-module="govuk-tabs">
                <ul class="govuk-tabs__list">
                    <li class="govuk-tabs__list-item govuk-tabs__list-item--selected">
                        <a class="govuk-tabs__tab" href="#details">
                            Details
                        </a>
                    </li>
                    <li class="govuk-tabs__list-item @Html.Conditional(!Model.IsLoggedIn, "last")">
                        <a class="govuk-tabs__tab" href="#product-schedules">
                            Product schedules
                        </a>
                    </li>
                    @if (Model.IsLoggedIn)
                    {
                        <li class="govuk-tabs__list-item">
                            <a class="govuk-tabs__tab" href="#supporting-documents">
                                Supporting documents
                            </a>
                        </li>
                        <li class="govuk-tabs__list-item last">
                            <a class="govuk-tabs__tab" href="#archive">
                                @Html.Conditional(Model.IsArchived, "Archived", "Archive")
                            </a>
                        </li>
                    }
                </ul>

                <div class="govuk-tabs__panel cabs-panel" id="details">
                    <div class="cab-detail-section">
                        <h2 class="govuk-heading-l">@Constants.Heading.CabDetails</h2>
                        <dl class="govuk-summary-list">
                            <div class="govuk-summary-list__row">
                                <dt class="govuk-summary-list__key">
                                    CAB name
                                </dt>
                                <dd class="govuk-summary-list__value">
                                    @Model.Name
                                </dd>
                            </div>                            
                            <div class="govuk-summary-list__row">
                                <dt class="govuk-summary-list__key">
                                    @Html.Conditional(Model.IsLoggedIn, "CAB number", "Body number")
                                </dt>
                                <dd class="govuk-summary-list__value">
                                    @Model.BodyNumber
                                </dd>
                            </div>

                            @if (Model.IsLoggedIn)
                            {                               
                                <div class="govuk-summary-list__row">
                                    <dt class="govuk-summary-list__key">
                                        Appointment date
                                    </dt>
                                    <dd class="govuk-summary-list__value">
                                        @Html.Conditional(Model.AppointmentDate != null, Model.AppointmentDate.ToString(), @Constants.NotProvided)
                                    </dd>
                                </div>

                                <div class="govuk-summary-list__row">
                                    <dt class="govuk-summary-list__key">
                                        Review date
                                    </dt>
                                    <dd class="govuk-summary-list__value">
                                        @Html.Conditional(Model.ReviewDate != null, Model.ReviewDate.ToString(), @Constants.NotProvided)
                                    </dd>
                                </div>
                            }                        
                            <div class="govuk-summary-list__row">
                                <dt class="govuk-summary-list__key">
                                    UKAS reference number
                                </dt>
                                <dd class="govuk-summary-list__value">
                                    @Html.Conditional(!string.IsNullOrWhiteSpace(Model.UKASReferenceNumber), Model.UKASReferenceNumber, @Constants.NotProvided)
                                </dd>
                            </div>
                        </dl>
                    </div>
                    <div class="cab-detail-section">
                        <h2 class="govuk-heading-l">Contact details</h2>
                        <dl class="govuk-summary-list">
                            <div class="govuk-summary-list__row">
                                <dt class="govuk-summary-list__key">
                                    Address
                                </dt>
                                <dd class="govuk-summary-list__value">
                                    @if (!string.IsNullOrWhiteSpace(Model.Address))
                                    {
                                        <text>@Html.Raw(Model.Address)</text>
                                    }
                                    else
                                    {
                                        <text>@Constants.NotProvided</text>
                                    }
                                </dd>
                            </div>
                            <div class="govuk-summary-list__row">
                                <dt class="govuk-summary-list__key">
                                    Website
                                </dt>
                                <dd class="govuk-summary-list__value">
                                    @if (!string.IsNullOrWhiteSpace(Model.Website))
                                    {
                                        <a class="govuk-link" href="@Html.SanitiseURL(Model.Website)" target="_blank">@Model.Website</a>
                                    }
                                    else
                                    {
                                        <text>@Constants.NotProvided</text>
                                    }
                                </dd>
                            </div>
                            <div class="govuk-summary-list__row">
                                <dt class="govuk-summary-list__key">
                                    Email
                                </dt>
                                <dd class="govuk-summary-list__value">
                                    @if (!string.IsNullOrWhiteSpace(Model.Email))
                                    {
                                        <a class="govuk-link" href="mailto: @Model.Email">@Model.Email</a>
                                    }
                                    else
                                    {
                                        @Constants.NotProvided
                                    }
                                </dd>
                            </div>
                            <div class="govuk-summary-list__row">
                                <dt class="govuk-summary-list__key">
                                    Telephone
                                </dt>
                                <dd class="govuk-summary-list__value">
                                    @Html.Conditional(!string.IsNullOrWhiteSpace(Model.Phone), Model.Phone, @Constants.NotProvided)
                                </dd>
                            </div>

                            @if (Model.IsPointOfContactPublicDisplay || Model.IsLoggedIn)
                            {
                                <div class="govuk-summary-list__row">
                                    <dt class="govuk-summary-list__key">
                                        Point of contact name
                                    </dt>
                                    <dd class="govuk-summary-list__value">
                                        @Html.Conditional(!string.IsNullOrWhiteSpace(Model.PointOfContactName), Model.PointOfContactName, @Constants.NotProvided)
                                    </dd>
                                </div>
                                <div class="govuk-summary-list__row">
                                    <dt class="govuk-summary-list__key">
                                        Point of contact email
                                    </dt>
                                    <dd class="govuk-summary-list__value">
                                        @if (!string.IsNullOrWhiteSpace(Model.PointOfContactEmail))
                                        {
                                            <a class="govuk-link" href="mailto: @Model.PointOfContactEmail">@Model.PointOfContactEmail</a>
                                        }
                                        else
                                        {
                                            @Constants.NotProvided
                                        }
                                    </dd>
                                </div>
                                <div class="govuk-summary-list__row">
                                    <dt class="govuk-summary-list__key">
                                        Point of contact telephone
                                    </dt>
                                    <dd class="govuk-summary-list__value">
                                        @Html.Conditional(!string.IsNullOrWhiteSpace(Model.PointOfContactPhone), Model.PointOfContactPhone, @Constants.NotProvided)
                                    </dd>
                                </div>
                            }





                            <div class="govuk-summary-list__row">
                                <dt class="govuk-summary-list__key">
                                    Registered office location
                                </dt>
                                <dd class="govuk-summary-list__value">
                                    @Html.Conditional(!string.IsNullOrWhiteSpace(Model.RegisteredOfficeLocation), Model.RegisteredOfficeLocation, @Constants.NotProvided)
                                </dd>
                            </div>
                        </dl>
                    </div>
                    <div class="cab-detail-section">
                        <h2 class="govuk-heading-l">Body details</h2>
                        <dl class="govuk-summary-list">
                            <div class="govuk-summary-list__row">
                                <dt class="govuk-summary-list__key">
                                    Registered test location
                                </dt>
                                <dd class="govuk-summary-list__value">
                                    @if (!Model.RegisteredTestLocations.Any())
                                    {
                                        <text>@Constants.NotProvided</text>
                                    }
                                    else
                                    {
                                        foreach (var testLocation in Model.RegisteredTestLocations)
                                        {
                                            <span class="cab-detail-list-item">@testLocation</span>
                                        }
                                    }
                                </dd>
                            </div>                        
                            <div class="govuk-summary-list__row">
                                <dt class="govuk-summary-list__key">
                                    Body type
                                </dt>
                                <dd class="govuk-summary-list__value">
                                    @if (!Model.BodyTypes.Any())
                                    {
                                        <text>@Constants.NotProvided</text>
                                    }
                                    else
                                    {
                                        @foreach (var bodyType in Model.BodyTypes)
                                        {
                                            <span class="cab-detail-list-item">@bodyType</span>
                                        }
                                    }
                                </dd>
                            </div>
                            <div class="govuk-summary-list__row">
                                <dt class="govuk-summary-list__key">
                                    Legislative area
                                </dt>
                                <dd class="govuk-summary-list__value">
                                    @if (!Model.LegislativeAreas.Any())
                                    {
                                        <text>@Constants.NotProvided</text>
                                    }
                                    else
                                    {
                                        @foreach (var legislativeArea in Model.LegislativeAreas)
                                        {
                                            <span class="cab-detail-list-item">@legislativeArea</span>
                                        }
                                    }
                                </dd>
                            </div>
                        </dl>
                    </div>
                </div>

                <partial name="Partials/_Documents" model="Model.ProductSchedules" />


                @if (Model.IsLoggedIn)
                {
                    <partial name="Partials/_Documents" model="Model.SupportingDocuments" />

                    <div class="govuk-tabs__panel cabs-panel govuk-tabs__panel--hidden" id="archive">
                        <div class="cab-detail-section">
                            <h2 class="govuk-heading-l">@Html.Conditional(Model.IsArchived, "Archived", "Archive")</h2>
                            @if (Model.IsArchived)
                            {
                                <p class="govuk-body">Archived on @Model.ArchivedDate by @Model.ArchivedBy</p>
                                <p class="govuk-body">@Model.ArchiveReason</p>
                            }
                            else
                            {
                                <form method="post">
                                    <div class="govuk-!-width-two-thirds">
                                        <div class="govuk-form-group @Html.ShowModelStateFormGroupErrorClass(ViewData.ModelState, nameof(Model.ArchiveReason))">
                                            <div id="archive-hint" class="govuk-hint">
                                                State the reason for archiving this CAB record.
                                            </div>
                                            <p class="govuk-error-message">
                                                <span asp-validation-for="ArchiveReason" class="govuk-error-message"></span>
                                            </p>
                                            <textarea class="govuk-textarea  @Html.ShowModelStateInputErrorClass(ViewData.ModelState, nameof(Model.ArchiveReason))" asp-for="ArchiveReason" rows="5" aria-describedby="archive-hint"></textarea>
                                        </div>
                                        <div class="govuk-warning-text">
                                            <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
                                            <strong class="govuk-warning-text__text">
                                                <span class="govuk-warning-text__assistive">Warning</span>
                                                Archiving this CAB record will remove it from the search results. Once archived the record can be re-published and returned to the search results by internal users.
                                            </strong>
                                        </div>
                                        <div class="govuk-button-group">
                                            <button class="govuk-button" data-module="govuk-button" name="submitType" value="@Constants.SubmitType.Continue">
                                                Continue
                                            </button>
                                            <a asp-area="Admin" asp-controller="Admin" asp-action="Index" class="govuk-link govuk-link--no-visited-state">Cancel</a>
                                        </div>
                                    </div>
                                </form>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
    <div class="govuk-grid-row">
        <div class="atom-feed atom-feed-bottom govuk-grid-column-two-thirds">
            @if (!Model.IsArchived)
            {
                <partial name="Partials/_FeedLinks" model="Model.FeedLinksViewModel" />
            }
        </div>
    </div>
</div>