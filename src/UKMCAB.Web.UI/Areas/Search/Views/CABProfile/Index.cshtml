@using System.Net
@using UKMCAB.Core.Domain;
@model CABProfileViewModel
@{
    ViewData["nav"] = "search";
    ViewData["pageTitle"] = Model.Title;
    var returnUrl = WebUtility.UrlEncode(this.Url.ActionContext.HttpContext.Request.GetRequestUri().PathAndQuery);
}
    
@section BackButton
{
    @if (Model.IsArchived)
    {
        <div class="govuk-width-container ">
            <div class="govuk-grid-row">
                <div class="govuk-grid-column-two-thirds">
                    <a asp-area="Admin" asp-controller="Admin" asp-action="CABManagement" class="govuk-back-link">Back</a>
                </div>
            </div>
        </div>
    }
    else if (Model.ReturnUrl == "confirmation")
    {
        <div class="govuk-width-container ">
            <div class="govuk-grid-row">
                <div class="govuk-grid-column-two-thirds">
                    <a asp-area="Admin" asp-controller="CAB" asp-action="Confirmation" asp-route-id="@Model.CABId" class="govuk-back-link">Back</a>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="govuk-width-container ">
            <div class="govuk-grid-row">
                <div class="govuk-grid-column-two-thirds">
                    <a href="@Model.ReturnUrl" class="govuk-back-link">Back to Search Results</a>
                </div>
            </div>
        </div>
    }
}
<div id="cab-profile-page">
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            <partial name="Partials/_ValidationSummary" model="null" />
        </div>
    </div>
    @if (Model.IsArchived)
    {
        <div class="govuk-notification-banner" role="region"
             aria-labelledby="govuk-notification-banner-title"
             data-module="govuk-notification-banner">
            <div class="govuk-notification-banner__content">

                <div class="govuk-warning-text">
                    <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
                    <strong class="govuk-warning-text__text">
                        <p class="govuk-notification-banner__heading">Archived on @Model.ArchivedDate</p>
                    </strong>
                </div>
            </div>
        </div>
    }

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-one-half">
            <span class="govuk-caption-m govuk-!-margin-bottom-3">CAB profile</span>
            <h1 class="govuk-heading-l">@Model.Name</h1>
            <div class="cab-detail-date-meta">
                <span class="govuk-caption-m govuk-!-display-inline-block govuk-!-margin-right-5">Published: @(Model.PublishedDate.HasValue ? Model.PublishedDate.Value.ToString("d MMM yyyy") : string.Empty)</span>
                <span class="govuk-caption-m govuk-!-display-inline-block">Last updated: @(Model.LastModifiedDate.HasValue ? Model.LastModifiedDate.Value.ToString("d MMM yyyy") : string.Empty)</span>
            </div>
        </div>
        <div class="govuk-grid-column-one-half">

            <div class="govuk-!-margin-right-3">

                <div class="atom-feed atom-feed-top">
                    @if (!Model.IsArchived)
                    {
                        <partial name="Partials/_FeedLinks" model="Model.FeedLinksViewModel" />
                    }
                </div>

                @if (User.HasClaim(UKMCAB.Core.Security.Claims.CabEdit, "*")) // TODO:  purposefully disabled; need to figure out permissions first
                {
                    <div id="admin-buttons-container">
                        @if (Model.IsArchived && !Model.IsUnarchivedRequest)
                        {
                            <span>
                                <a id="unarchive-button" class="modal-button govuk-button govuk-button--secondary" data-modal-id="unarchive-modal" asp-area="Search" asp-controller="CABProfile" asp-action="UnarchiveCAB" asp-route-id="@Model.CABId" asp-route-returnUrl="@returnUrl">Unarchive</a>
                            </span>
                        }
                        @if(Model.IsPublished)
                        {
                            <span>
                                <a class="govuk-button govuk-button--secondary" asp-area="Admin" asp-controller="CAB" asp-action="Summary" asp-route-id="@Model.CABId" asp-route-returnUrl="@returnUrl">Edit</a>
                            </span>
                            <span>
                                <a id="archive-button" class="modal-button govuk-button govuk-button--secondary" data-modal-id="archive-modal" asp-area="Search" asp-controller="CABProfile" asp-action="ArchiveCAB" asp-route-id="@Model.CABId" asp-route-returnUrl="@returnUrl">Archive</a>
                            </span>
                        }
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-full">
            <div class="govuk-tabs cab-tabs" data-module="govuk-tabs">
                <ul class="govuk-tabs__list">
                    <li class="govuk-tabs__list-item @Html.Conditional(!Context.Request.Query.Keys.Contains("pagenumber"), "govuk-tabs__list-item--selected")">
                        <a class="govuk-tabs__tab" href="#details">
                            Details
                        </a>
                    </li>
                    <li class="govuk-tabs__list-item @Html.Conditional(!User.Identity.IsAuthenticated, "last")">
                        <a class="govuk-tabs__tab" href="#product-schedules">
                            Product schedules
                        </a>
                    </li>
                    @if (User.Identity.IsAuthenticated /*todo*/)
                    {
                        <li class="govuk-tabs__list-item">
                            <a class="govuk-tabs__tab" href="#supporting-documents">
                                Supporting documents
                            </a>
                        </li>
                    }
                    <li class="govuk-tabs__list-item @Html.Conditional(Context.Request.Query.Keys.Contains("pagenumber"), "govuk-tabs__list-item--selected" )">
                        <a class="govuk-tabs__tab" href="#history">
                            History
                        </a>
                    </li>
                </ul>

                <div class="govuk-tabs__panel cabs-panel" id="details">
                    <div class="cab-detail-section">
                        <h2 class="govuk-heading-l">@Constants.Heading.CabDetails</h2>
                        <dl class="govuk-summary-list">
                            <div class="govuk-summary-list__row">
                                <dt class="govuk-summary-list__key">
                                    CAB name
                                </dt>
                                <dd class="govuk-summary-list__value">
                                    @Model.Name
                                </dd>
                            </div>
                            
                            @if (CabNumberVisibility.CanDisplay(Model.CabNumberVisibility, User))
                            {
                                <div class="govuk-summary-list__row">
                                    <dt class="govuk-summary-list__key">
                                        @Html.Conditional(User.Identity.IsAuthenticated, "CAB number", "Body number")
                                    </dt>
                                    <dd class="govuk-summary-list__value">
                                        @Model.BodyNumber
                                    </dd>
                                </div>
                            }

                            @if (User.Identity.IsAuthenticated)
                            {                               
                                <div class="govuk-summary-list__row">
                                    <dt class="govuk-summary-list__key">
                                        Appointment date
                                    </dt>
                                    <dd class="govuk-summary-list__value">
                                        @Html.Conditional(Model.AppointmentDate != null, Model.AppointmentDate?.ToString("d MMM yyyy"), @Constants.NotProvided)
                                    </dd>
                                </div>

                                <div class="govuk-summary-list__row">
                                    <dt class="govuk-summary-list__key">
                                        Review date
                                    </dt>
                                    <dd class="govuk-summary-list__value">
                                        @Html.Conditional(Model.ReviewDate != null, Model.ReviewDate?.ToString("d MMM yyyy"), @Constants.NotProvided)
                                    </dd>
                                </div>
                            }                        
                            <div class="govuk-summary-list__row">
                                <dt class="govuk-summary-list__key">
                                    UKAS reference number
                                </dt>
                                <dd class="govuk-summary-list__value">
                                    @Html.Conditional(!string.IsNullOrWhiteSpace(Model.UKASReferenceNumber), Model.UKASReferenceNumber, @Constants.NotProvided)
                                </dd>
                            </div>
                        </dl>
                    </div>
                    <div class="cab-detail-section">
                        <h2 class="govuk-heading-l">Contact details</h2>
                        <dl class="govuk-summary-list">
                            <div class="govuk-summary-list__row">
                                <dt class="govuk-summary-list__key">
                                    Address
                                </dt>
                                <dd class="govuk-summary-list__value">
                                    @if (!string.IsNullOrWhiteSpace(Model.Address))
                                    {
                                        <text>@Html.Raw(Model.Address)</text>
                                    }
                                    else
                                    {
                                        <text>@Constants.NotProvided</text>
                                    }
                                </dd>
                            </div>
                            <div class="govuk-summary-list__row">
                                <dt class="govuk-summary-list__key">
                                    Website
                                </dt>
                                <dd class="govuk-summary-list__value">
                                    @if (!string.IsNullOrWhiteSpace(Model.Website))
                                    {
                                        <a class="govuk-link" href="@Html.SanitiseURL(Model.Website)" target="_blank">@Model.Website</a>
                                    }
                                    else
                                    {
                                        <text>@Constants.NotProvided</text>
                                    }
                                </dd>
                            </div>
                            <div class="govuk-summary-list__row">
                                <dt class="govuk-summary-list__key">
                                    Email
                                </dt>
                                <dd class="govuk-summary-list__value">
                                    @if (!string.IsNullOrWhiteSpace(Model.Email))
                                    {
                                        <a class="govuk-link" href="mailto: @Model.Email">@Model.Email</a>
                                    }
                                    else
                                    {
                                        @Constants.NotProvided
                                    }
                                </dd>
                            </div>
                            <div class="govuk-summary-list__row">
                                <dt class="govuk-summary-list__key">
                                    Telephone
                                </dt>
                                <dd class="govuk-summary-list__value">
                                    @Html.Conditional(!string.IsNullOrWhiteSpace(Model.Phone), Model.Phone, @Constants.NotProvided)
                                </dd>
                            </div>

                            @if (Model.IsPointOfContactPublicDisplay || User.Identity.IsAuthenticated /*TODO; what role/claim?*/)
                            {
                                <div class="govuk-summary-list__row">
                                    <dt class="govuk-summary-list__key">
                                        Point of contact name
                                    </dt>
                                    <dd class="govuk-summary-list__value">
                                        @Html.Conditional(!string.IsNullOrWhiteSpace(Model.PointOfContactName), Model.PointOfContactName, @Constants.NotProvided)
                                    </dd>
                                </div>
                                <div class="govuk-summary-list__row">
                                    <dt class="govuk-summary-list__key">
                                        Point of contact email
                                    </dt>
                                    <dd class="govuk-summary-list__value">
                                        @if (!string.IsNullOrWhiteSpace(Model.PointOfContactEmail))
                                        {
                                            <a class="govuk-link" href="mailto: @Model.PointOfContactEmail">@Model.PointOfContactEmail</a>
                                        }
                                        else
                                        {
                                            @Constants.NotProvided
                                        }
                                    </dd>
                                </div>
                                <div class="govuk-summary-list__row">
                                    <dt class="govuk-summary-list__key">
                                        Point of contact telephone
                                    </dt>
                                    <dd class="govuk-summary-list__value">
                                        @Html.Conditional(!string.IsNullOrWhiteSpace(Model.PointOfContactPhone), Model.PointOfContactPhone, @Constants.NotProvided)
                                    </dd>
                                </div>
                            }

                            <div class="govuk-summary-list__row">
                                <dt class="govuk-summary-list__key">
                                    Registered office location
                                </dt>
                                <dd class="govuk-summary-list__value">
                                    @Html.Conditional(!string.IsNullOrWhiteSpace(Model.RegisteredOfficeLocation), Model.RegisteredOfficeLocation, @Constants.NotProvided)
                                </dd>
                            </div>
                        </dl>
                    </div>
                    <div class="cab-detail-section">
                        <h2 class="govuk-heading-l">Body details</h2>
                        <dl class="govuk-summary-list">
                            <div class="govuk-summary-list__row">
                                <dt class="govuk-summary-list__key">
                                    Registered test location
                                </dt>
                                <dd class="govuk-summary-list__value">
                                    @if (!Model.RegisteredTestLocations.Any())
                                    {
                                        <text>@Constants.NotProvided</text>
                                    }
                                    else
                                    {
                                        foreach (var testLocation in Model.RegisteredTestLocations)
                                        {
                                            <span class="cab-detail-list-item">@testLocation</span>
                                        }
                                    }
                                </dd>
                            </div>                        
                            <div class="govuk-summary-list__row">
                                <dt class="govuk-summary-list__key">
                                    Body type
                                </dt>
                                <dd class="govuk-summary-list__value">
                                    @if (!Model.BodyTypes.Any())
                                    {
                                        <text>@Constants.NotProvided</text>
                                    }
                                    else
                                    {
                                        @foreach (var bodyType in Model.BodyTypes)
                                        {
                                            <span class="cab-detail-list-item">@bodyType</span>
                                        }
                                    }
                                </dd>
                            </div>
                            <div class="govuk-summary-list__row">
                                <dt class="govuk-summary-list__key">
                                    Legislative area
                                </dt>
                                <dd class="govuk-summary-list__value">
                                    @if (!Model.LegislativeAreas.Any())
                                    {
                                        <text>@Constants.NotProvided</text>
                                    }
                                    else
                                    {
                                        @foreach (var legislativeArea in Model.LegislativeAreas)
                                        {
                                            <span class="cab-detail-list-item">@legislativeArea</span>
                                        }
                                    }
                                </dd>
                            </div>
                        </dl>
                    </div>
                </div>

                <partial name="Partials/_Documents" model="Model.ProductSchedules" />

                @if (User.Identity.IsAuthenticated /*todo: what claim?*/)
                {
                    <partial name="Partials/_Documents" model="Model.SupportingDocuments" />
                }
            
                <partial name="Partials/_History" model="Model.AuditLogHistory" />

            </div>
        </div>
    </div>
    <div class="govuk-grid-row">
        <div class="atom-feed atom-feed-bottom govuk-grid-column-two-thirds">
            @if (!Model.IsArchived)
            {
                <partial name="Partials/_FeedLinks" model="Model.FeedLinksViewModel" />
            }
        </div>
    </div>
</div>

<!-- Archive modal content -->
<div id="archive-modal" class="modal">
    <div class="govuk-grid-row">
        <div class="modal-content">
            <div class="govuk-!-width-full">
                <div id="close-container"><a href="#" class="modal-close govuk-link">Close</a>
                </div>
            </div>
            <form method="post">
                <div class="govuk-!-width-full">
                    <h2 class="govuk-heading-l break-word">Archive @Model.Name</h2>
                    <input type="hidden" asp-for="CABId" value="@Model.CABId"/>
                     @if (Model.HasDraft)
                    {
                        <div class="govuk-inset-text govuk-inset-text-alert govuk-tag--red">
                            <strong>This CAB  has a draft profile connected to it. If you archive this CAB, the draft will be deleted.</strong>
                        </div>
                    }
                    <div id="archive-reason-formgroup" class="govuk-form-group">
                        <div id="archive-hint" class="govuk-hint">
                            Enter the reason for archiving this CAB.
                        </div>
                        <p id="archive-reason-error" class="govuk-error-message govuk-visually-hidden">
                            <span id="archive-error-message" class="govuk-error-message"></span>
                        </p>
                        <textarea id="archive-reason" class="govuk-textarea" asp-for="ArchiveReason" rows="5" aria-describedby="archive-hint"></textarea>
                    </div>
                    <div class="govuk-warning-text">
                        <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
                        <strong class="govuk-warning-text__text">
                            <span class="govuk-warning-text__assistive">Warning</span>
                            Archived CAB profiles cannot be edited and users cannot view them in the search results.
                        </strong>
                    </div>
                    <div class="govuk-button-group">
                        <button id="archive-submit-button" class="govuk-button" data-module="govuk-button" name="submitType" value="@Constants.SubmitType.Continue">
                            Archive
                        </button>
                        <a href="#" class="modal-close govuk-link">Cancel</a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Unarchive modal content -->
<div id="unarchive-modal" class="modal">
    <div class="govuk-grid-row">
        <div class="modal-content">
            <div class="govuk-!-width-full">
                <div id="close-container">
                    <a href="#" class="modal-close govuk-link">Close</a>
                </div>
            </div>
            <form method="post">
                <div class="govuk-!-width-full">
                    <h2 class="govuk-heading-l">Unarchive @Model.Name</h2>
                    <div id="unarchive-reason-formgroup" class="govuk-form-group">
                        <div id="unarchive-hint" class="govuk-hint">
                            Enter the reason for unarchiving this CAB profile.
                        </div>
                        <p id="unarchive-reason-error" class="govuk-error-message govuk-visually-hidden">
                            <span id="unarchive-error-message" class="govuk-error-message"></span>
                        </p>
                        <textarea id="unarchive-reason" class="govuk-textarea" name="UnarchiveReason" rows="5" aria-describedby="unarchive-hint"></textarea>
                    </div>
                    <div class="govuk-warning-text">
                        <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
                        <strong class="govuk-warning-text__text">
                            <span class="govuk-warning-text__assistive">Warning</span>
                            Unarchived CAB profiles will be saved as draft.
                        </strong>
                    </div>
                    <div class="govuk-button-group">
                        <button id="unarchive-submit-button" class="govuk-button" data-module="govuk-button" name="submitType" value="@Constants.SubmitType.Continue">
                            Unarchive
                        </button>
                        <a href="#" class="modal-close govuk-link">Cancel</a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>